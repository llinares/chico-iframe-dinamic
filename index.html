<html>
<head>
<title>Probando modales</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link href="http://static.mlstatic.com/org-img/ch/ui/0.10.7/chico.min.css" type="text/css" rel="stylesheet"/>
</head>

<body>

<h1>Probando creacion de modales con soporte Post Message</h1>
<br />
<ul>
	<li>class="iframe-modal"</li>
	<li>data-modal:dinamic="boolean"</li>
	<li>data-modal:width="number"</li>
	<li>data-modal:height="number"</li>
	<li>data-modal:url="string"</li>
</ul>

<hr />

<h2>Elegí una opcion</h2>
<br />
<p><a href="./iframe.html" class="iframe-modal" data-modal:dinamic="true" data-modal:width="500" data-modal:height="300" data-modal:url="./iframe.html?go=1" target="_blank">Abrir un modal de 500x300 - Target blank para browsers sin soporte</a></p>
<p><a href="./iframe.html" class="iframe-modal" data-modal:dinamic="true" data-modal:width="700" data-modal:height="400" data-modal:url="http://mercadolibre.com.ar" target="_blank">Abrir un modal de 700x400 - Target blank para browsers sin soporte</a></p>
<p><a href="./iframe.html" class="iframe-modal" data-modal:dinamic="false" data-modal:width="200" data-modal:height="200" data-modal:url="./iframe.html?go=3" target="_blank">Abrir un modal de 200x200 - Target blank para browsers sin soporte</a></p>



<script type='text/javascript' src="http://static.mlstatic.com/org-img/ch/ui/0.10.7/chico-jquery.min.js"></script>

<script>

// Componente para recibir los mensajes y ejecutar la accion correspondiente
var iframeMessageCallback = (function() {

	// Almacera el modal abierto localmente
	var _modal;

    // Mapa de mensajes y su funcion.
	var mapa = {

		// Resize del modal con/sin animacion
		resize: function (width,height,animate,speed) {

			var speed = parseInt(speed) || "normal";

			if(animate == "true"){

				$(".ch-modal").animate({
					"width": width,
					"height": height
				},{
					duration: speed,
					step: function(){
						_modal.position("refresh");
					}
				});

			}else{

				_modal.width(width).height(height).position("refresh");

			}

		},

		// Cerrar el modal
		close: function (){

			_modal.hide();

		},

		// Borrar loading/botton cerrar
		remove: function(element){

			switch(element){

				case "loading":
					$(".ch-modal iframe").attr("style",'');
					break;

				case "close":
					$(".ch-modal .ch-close").hide();
					break;

			}

		},

		// Agregar loading
		add: function(element){

			var styles = $(".ch-modal iframe").attr("data-css");

			$(".ch-modal iframe").attr("style",styles);

		}

	}

    // Funcion para llamar a los mensajes
	function messageHandler(message){

		message = message.data.split("=");

		var method = mapa[message[0]];

		var arguments = [];

		if( typeof method != 'undefined' ){

			if(message[1]){

				var messageArray = message[1].split("&");
				var i;

				for( i = 0; messageArray.length > i; i++){

					arguments.push(messageArray[i]);

				}

			}

			method.apply(this, arguments);
		}

	}

	// Crea nuevos mensajes
	function bind(message,f){

		mapa[message] = f ;

	}

	// Detecta si tiene soporte para post Message y escucha cuando envian un mensaje
	function init(){

		if (window.postMessage){


			if(typeof window.addEventListener != 'undefined'){

			    window.addEventListener('message', messageHandler, false);

			}
			else if(typeof window.attachEvent != 'undefined'){

			    window.attachEvent('onmessage', messageHandler);

			}

		}

		return this;

	}

	function setModal(modal){

		_modal = modal;

	}

    return{
    	bind:bind,
    	init:init,
    	setModal:setModal
    }

})();

/* Manera de escuchar eventos personalizados */
// En iframe -> window.parent.postMessage("selogueo",urlParent);
// En parent -> iframeMessageCallback.bind('selogueo',function() { alert("se logueo"); }); (Asi lo agregamos al mapa y lo ejecutamos)

// Componente que crea el modal, lo muestra y decide si debe escuchar los mensajes

var iframeModal = (function() {

	var _modal = $("<a>").modal({
		closable: "button",
		onShow: function(){
			$(".ch-modal .ch-close").show();
			$(".ch-dimmer").one("click",function(){
				_modal.hide();
			})

		},
		onHide: function(){
			$("#modal-iframe").attr("src","about:blank");
		}
	});

	var _iframeMessageCallback;
	var _iframeStyles = "background-image: url(data:image/gif;base64,R0lGODlhLAAsAPECAMXe/zNmzAAAAAAAACH/C05FVFNDQVBFMi4wAwEAAAAh+QQFBwACACwAAAAALAAsAAACkpSPmcGhD2NsTdq7qMPcgA8g2uaBnQKaxnik34m44UHFLtzeloyX6cXrCX4YovB4MiJzL5RuOXwyVdCgTYm0TptV6RR6nYHH5LIZezZpy7I1ue19w6npH5pNN+v3/F1+eecm5CbYQxg3GFeII3h35NjH+AcBCYSYsOhX6TNZJKWUKWE1eunJFQXamVVap6q3GVEAACH5BAUHAAIALBMAAAAPAAkAAAIbFA6iy4gM3YFNsoCDsSrnPS0eRolj2Z2o4AkFACH5BAUHAAIALBwAAwANAA0AAAIbFA6iq4i83IFNUmOvu7zDAAZcGF4kaJ4pOZYFACH5BAUHAAIALCMACgAJAA8AAAIcFA6ihrftFEwSLhav3ryvAAZXGH6kqJyooI5lAQAh+QQFBwACACwjABMACQAPAAACG5QFCYea556Ja0bmmN6chx8wIHiMX2mio0geBQAh+QQFBwACACwcABwADQANAAACHJRvoIC429JjcdJmo1S6hx944KeNZGSGqCmeUQEAIfkEBQcAAgAsEwAjAA8ACQAAAhqUj6CALbvcgUqEGxLFeG6eeRUYSqR0cKhRAAAh+QQFBwACACwKACMADwAJAAACG1QeosuIDN2BTTKAgbEq5z0tHkaJY9mdqOAJBQAh+QQFBwACACwDABwADQANAAACG1QeoquIvNyBTVJjr7u8QwACXBheJGieKTmWBQAh+QQFBwACACwAABMACQAPAAACHFQeooa37RRMEi4Wr968LwACVxh+pKicqKCOZQEAIfkEBQcAAgAsAAAKAAkADwAAAhuUFRmHmueeiWtG5pjenIMPMCB4jF9poqNIHgUAIfkEBQcAAgAsAwADAA0ADQAAAhyUb6GBuNvSY3HSZqNUuoMPeOCnjWRkhqgpnlEBADs=); background-position:50% 50%; background-repeat:no-repeat;";

	function buildIframe(url,dinamic){

		if(dinamic == undefined){
			dinamic = false;
		};

		// Agrego la url parent al final de la url para poder enviar mensajes
    	if( dinamic ){
    		if ( url.indexOf('?') == -1){
    			url += "?";
    		}
    		url += "&parent_url=" + encodeURIComponent(window.location);
    	}

		return "<iframe id=\"modal-iframe\" src=\"" + url + "\" width=\"100%\" height=\"100%\" data-css=\"" + _iframeStyles + "\" scrolling=\"auto\" frameborder=\"0\" style=\"" + _iframeStyles + "\"></iframe>";

	}

	function open(event){

		// Recupero los datos del link
		var that = $(this);
    	var dinamic = that.attr("data-modal:dinamic") == "true";
    	var width = that.attr("data-modal:width");
    	var height = that.attr("data-modal:height");
    	var url = that.attr("data-modal:url");

    	if (!dinamic || (window.postMessage && dinamic)){

	    	// Seteo tamaños, contenido y muestro el modal
			_modal.width(width).height(height).content(buildIframe(url,dinamic)).show();

			// Inicializo iframeModalMessage solo si es necesario
			if( iframeMessageCallback != null ){

				iframeMessageCallback.setModal(_modal);
			}

			event.preventDefault();

		}

	}

	function init(iframeMessageCallback) {

		_iframeMessageCallback = iframeMessageCallback;

		// Bindeo evento en links que levantaran el modal
		$(".iframe-modal").bind("click",open);
	}

	return {
		init:init,
		buildIframe:buildIframe
	}

}());

iframeMessageCallback.init();

iframeModal.init(iframeMessageCallback);

</script>
</body>

</html>